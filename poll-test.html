<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>Global Poll</title>
<style>
  body { font-family:sans-serif; display:flex; flex-direction:column; align-items:center; padding:40px; }
  h2 { margin-bottom:20px; }
  .option { margin:5px 0; padding:10px 20px; background:#fff; border-radius:8px; cursor:pointer; width:300px; text-align:center; }
  .option:hover { background:#ddeeff; }
  .bar-container { width:300px; background:#eee; border-radius:8px; margin:5px 0; height:24px; position:relative; }
  .bar { background:#3b82f6; height:100%; width:0%; border-radius:8px; }
  .bar-label { position:absolute; width:100%; text-align:center; line-height:24px; color:#000; font-weight:bold; }
</style>
</head>
<body>

<h2>Which game engine do you prefer?</h2>
<div id="options"></div>
<h3 id="totals"></h3>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
  import { getDatabase, ref, get, runTransaction } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCb9A2wqpcg8K3gJmNg7F1hPqInp2910u8",
    authDomain: "hamster-hub-1.firebaseapp.com",
    databaseURL: "https://hamster-hub-1-default-rtdb.firebaseio.com",
    projectId: "hamster-hub-1",
    storageBucket: "hamster-hub-1.firebasestorage.app",
    messagingSenderId: "833563548088",
    appId: "1:833563548088:web:bca8dc2a69b4de5d49d74d"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  const POLL_ID = 'favourite-engine-ue5';
  const OPTIONS = ['Unreal Engine 5','Unity','Godot','Other'];
  const votedKey = `voted_${POLL_ID}`;
  const voted = localStorage.getItem(votedKey);

  const optionsContainer = document.getElementById('options');
  const totals = document.getElementById('totals');

  function renderOptions(){
    optionsContainer.innerHTML = '';
    OPTIONS.forEach(opt => {
      const btn = document.createElement('div');
      btn.textContent = opt;
      btn.className = 'option';
      if(voted) btn.style.opacity = 0.5;
      btn.onclick = () => vote(opt);
      optionsContainer.appendChild(btn);
    });
  }

  async function vote(option){
    if(voted) { alert('You already voted!'); return; }
    const voteRef = ref(db, `polls/${POLL_ID}/${option}`);
    await runTransaction(voteRef, current => (current||0)+1);
    localStorage.setItem(votedKey, option);
    renderOptions();
    renderResults();
  }

  async function renderResults(){
    const pollRef = ref(db, `polls/${POLL_ID}`);
    const snapshot = await get(pollRef);
    const data = snapshot.val() || {};
    const totalVotes = Object.values(data).reduce((a,b)=>a+b,0);
    totals.textContent = `Total votes: ${totalVotes}`;

    // Add bar visualization
    optionsContainer.innerHTML = '';
    OPTIONS.forEach(opt => {
      const count = data[opt] || 0;
      const pct = totalVotes ? Math.round(count/totalVotes*100) : 0;

      const container = document.createElement('div');
      container.className = 'bar-container';

      const bar = document.createElement('div');
      bar.className = 'bar';
      bar.style.width = pct + '%';

      const label = document.createElement('div');
      label.className = 'bar-label';
      label.textContent = `${opt}: ${count} (${pct}%)`;

      container.appendChild(bar);
      container.appendChild(label);
      optionsContainer.appendChild(container);
    });
  }

  renderOptions();
  renderResults();
</script>

</body>
</html>
