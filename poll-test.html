<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Global Poll</title>
<style>
  body { font-family: sans-serif; display: flex; flex-direction: column; align-items: center; padding: 40px; background: #f0f0f0; }
  h2 { margin-bottom: 20px; }
  .option { margin: 5px 0; padding: 10px 20px; background: #fff; border-radius: 8px; cursor: pointer; width: 300px; text-align: center; }
  .option:hover { background: #ddeeff; }
  .bar-container { width: 300px; background: #eee; border-radius: 8px; margin: 5px 0; height: 24px; position: relative; }
  .bar { background: #3b82f6; height: 100%; width: 0%; border-radius: 8px; transition: width 0.5s; }
  .bar-label { position: absolute; width: 100%; text-align: center; line-height: 24px; color: #000; font-weight: bold; }
</style>
</head>
<body>

<h2>Which game engine do you prefer?</h2>
<div id="options"></div>
<h3 id="totals"></h3>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
import { getDatabase, ref, get, runTransaction } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-database.js";

// ===== Firebase config =====
const firebaseConfig = {
  apiKey: "AIzaSyCb9A2wqpcg8K3gJmNg7F1hPqInp2910u8",
  authDomain: "hamster-hub-1.firebaseapp.com",
  projectId: "hamster-hub-1",
  storageBucket: "hamster-hub-1.firebasestorage.app",
  messagingSenderId: "833563548088",
  appId: "1:833563548088:web:bca8dc2a69b4de5d49d74d"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);

// Regional URL for your Realtime Database
const db = getDatabase(app, "https://hamster-hub-1-default-rtdb.europe-west1.firebasedatabase.app");

// ===== Poll config =====
const POLL_ID = 'favourite-engine-ue5';
const OPTIONS = ['Unreal Engine 5','Unity','Godot','Other'];
const votedKey = `voted_${POLL_ID}`;
let voted = localStorage.getItem(votedKey);

const optionsContainer = document.getElementById('options');
const totals = document.getElementById('totals');

// Render buttons if user hasn't voted
function renderOptions() {
  optionsContainer.innerHTML = '';
  if(voted) {
    renderResults(); // already voted, show results
    return;
  }

  OPTIONS.forEach(opt => {
    const btn = document.createElement('div');
    btn.textContent = opt;
    btn.className = 'option';
    btn.onclick = () => vote(opt);
    optionsContainer.appendChild(btn);
  });
}

// Handle voting
async function vote(option){
  const voteRef = ref(db, `polls/${POLL_ID}/${option}`);
  await runTransaction(voteRef, current => (current||0)+1);
  localStorage.setItem(votedKey, option);
  voted = option;
  renderResults();
}

// Render results with bars
async function renderResults(){
  const pollRef = ref(db, `polls/${POLL_ID}`);
  const snapshot = await get(pollRef);
  const data = snapshot.val() || {};
  const totalVotes = Object.values(data).reduce((a,b)=>a+b,0);

  optionsContainer.innerHTML = '';
  OPTIONS.forEach(opt => {
    const count = data[opt] || 0;
    const pct = totalVotes ? Math.round(count/totalVotes*100) : 0;

    const container = document.createElement('div');
    container.className = 'bar-container';

    const bar = document.createElement('div');
    bar.className = 'bar';
    bar.style.width = pct + '%';

    const label = document.createElement('div');
    label.className = 'bar-label';
    label.textContent = `${opt}: ${count} (${pct}%)`;

    container.appendChild(bar);
    container.appendChild(label);
    optionsContainer.appendChild(container);
  });

  totals.textContent = `Total votes: ${totalVotes}`;
}

// Initial render
renderOptions();
</script>

</body>
</html>
